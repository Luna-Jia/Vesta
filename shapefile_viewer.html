<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W2MTTJPMHD"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-W2MTTJPMHD');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shapefile Viewer with Bootstrap</title>
    <!-- External CSS libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- External JS libraries -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        /* Styles for the map container */
        #map { height: 500px; width: 100%; }
        /* Styles for the legend */
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 { margin: 0 0 5px; color: #777; }
        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

        /* Styles for the main sidebar */
        .main-sidebar {
            height: 100%;
            width: 3em; /* Use em instead of px */
            min-width: 3em; /* Ensure minimum width */
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            background-color: #111;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 1.25em;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-sidebar a {
            padding: 0.9em 0;
            margin-bottom: 0.6em;
            text-decoration: none;
            font-size: 1.125em;
            color: #e6e5e5;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            transition: 0.3s;
        }

        /* Style for main sidebar icons */
        .main-sidebar .sidebar-icon {
            width: 1.2em; /* Reduced from 1.5em */
            height: 1.2em; /* Reduced from 1.5em */
            padding: 0.1em;
            filter: brightness(0) invert(1); /* This makes the icons white */
        }

        .main-sidebar:hover {
            width: 12em;
        }

        .main-sidebar:hover a {
            flex-direction: row;
            justify-content: flex-start;
            padding-left: 2em;
        }

        .main-sidebar .fa-bars {
            font-size: 1.5em;
            padding: 0.125em;
        }

        .menu-text {
            display: none;
            margin-left: 0.625em;
        }

        .main-sidebar:hover .menu-text {
            display: inline;
        }

        /* Styles for the secondary sidebar */
        .secondary-sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 999;
            top: 0;
            left: 3em; /* Adjusted to be adjacent to main sidebar */
            background-color: #f8f9fa;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 1.5625em;
        }

        .secondary-sidebar h3 {
            color: #333;
            margin-bottom: 1.25em;
        }

        .secondary-sidebar a {
            padding: 0.75em 0.5em 0.1em 0.4em; /* This controls the padding around the anchor elements (buttons) */
            margin-bottom: 0.1em; /* This controls the space between the buttons */
            text-decoration: none;
            font-size: 1.125em;
            color: #818181;
            display: flex;
            align-items: center;
            transition: 0.3s;
        }

        /* Style for secondary sidebar icons */
        .secondary-sidebar .sidebar-icon {
            width: 2em; /* This controls the width of the icons */
            height: 2em; /* This controls the height of the icons */
            padding: 0.4em; /* This controls the padding around the icons */
            filter: none; /* This keeps the icons black */
        }

        /* Style for import section */
        #importSection {
            padding-left: 1.25em;
        }

        /* Style for file input container */
        #importSection .mb-3 {
            max-width: 90%;
        }

        /* Style for file input */
        .form-control[type="file"] {
            font-size: 0.875em;
            height: auto;
            padding: 0.3em 0.75em;
            width: 100%;
        }

        /* Style for file input button */
        .form-control[type="file"]::file-selector-button {
            font-size: 0.875em;
            padding: 0.4em 0.5em;
        }

        #fileVariablesSection {
            padding: 10px;
            margin-top: 10px;
            border-top: 1px solid #ddd;
        }

        .file-toggle {
            cursor: pointer;
            padding: 5px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #fileName {
            font-weight: bold;
        }

        .variable-list {
            list-style-type: none;
            padding-left: 0;
            margin-top: 5px;
            display: none;
        }

        .variable-list li {
            padding: 3px 5px;
            border-bottom: 1px solid #eee;
        }

        .variable-list li:last-child {
            border-bottom: none;
        }

        #main {
            transition: margin-left 0.5s;
            margin-left: 3em; /* Width of the closed main sidebar */
            padding: 20px;
        }

        #workspaces {
            display: flex;
            border-bottom: 1px solid #ddd;
            padding: 10px 10px 0 10px;
            background-color: #f8f9fa;
            margin-left: -20px; /* Compensate for the main padding */
            padding-left: 20px; /* Add padding back on the left */
        }
        .workspace {
            padding: 5px 10px;
            margin-right: 5px;
            background-color: #e9ecef;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
        }

        .workspace.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
        }

        .close-workspace {
            margin-left: 5px;
            border: none;
            background: none;
            font-size: 18px;
            cursor: pointer;
        }

        #addWorkspace {
            padding: 0 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        .workspace-content {
            display: none;
            padding: 20px;
        }

        .workspace-content.active {
            display: block;
        }

        .map, .histogram {
            height: 500px;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Main sidebar -->
    <div id="mainSidebar" class="main-sidebar">
        <!-- Hamburger menu icon -->
        <a href="javascript:void(0)" onclick="toggleSecondaryNav()">
            <i class="fas fa-bars"></i>
        </a>
        
        <!-- Import button with icon -->
        <a href="javascript:void(0)" onclick="showImportOptions()">
            <img src="assets/dataIcon.png" alt="Import Data" class="sidebar-icon">
            <span class="menu-text">Import Data</span>
        </a>
        
        <!-- Visualizations button with icon -->
        <a href="javascript:void(0)" onclick="showVisualizationOptions()">
            <img src="assets/scatterPlotIcon.png" alt="Visualizations" class="sidebar-icon">
            <span class="menu-text">Visualizations</span>
        </a>

        <!-- Home button with icon -->
        <a href="vestaHome.html">
            <img src="assets/homeIcon.png" alt="Home" class="sidebar-icon">
            <span class="menu-text">Home</span>
        </a>
    </div>

    <!-- Secondary sidebar -->
    <div id="secondarySidebar" class="secondary-sidebar">
        <!-- Import section -->
        <div id="importSection" style="display: none;">
            <div class="mb-3">
                <label for="shpFile" class="form-label">Select .shp file:</label>
                <input type="file" class="form-control" id="shpFile" accept=".shp">
            </div>
            <div class="mb-3">
                <label for="dbfFile" class="form-label">Select .dbf file:</label>
                <input type="file" class="form-control" id="dbfFile" accept=".dbf">
            </div>
            <button onclick="processShapefile()" class="btn btn-primary">Upload and Render</button>
        </div>  

        <div id="fileVariablesSection" style="display: none;">
            <div id="fileNameToggle" class="file-toggle">
                <span id="fileName"></span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <ul id="variableList" class="variable-list"></ul>
        </div>

         <!-- Visualization buttons section -->
            <div id="visualizationButtons" style="display: none;">
                <!-- Map button with icon -->
                <a href="#" onclick="showMap()">
                    <img src="assets/mapIcon.png" alt="Map" class="sidebar-icon">
                    <span>Map</span>
                </a>
                <!-- Table button with icon -->
                <a href="#" onclick="showTable()">
                    <img src="assets/tableIcon.png" alt="Table" class="sidebar-icon">
                    <span>Table</span>
                </a>
                <!-- Histogram button with icon -->
                <a href="#" onclick="selectHistogramProperty()">
                    <img src="assets/histogramIcon.png" alt="Histogram" class="sidebar-icon">
                    <span>Histogram</span>
                </a>
                 <!-- Scatter Plot button with icon -->
                <a href="#" onclick="showScatterPlot()">
                    <img src="assets/scatterPlotIcon.png" alt="Scatter Plot" class="sidebar-icon">
                    <span>Scatter Plot</span>
                </a>

                <a href="#" onclick="showCumulativeDistribution()">
                    <img src="assets/cdPlotIcon.png" alt="Cumulative Distribution Plot" class="sidebar-icon">
                    <span>Cumulative Distribution Plot</span>
                </a>

                <a href="#" onclick="showHeatmap()">
                    <img src="assets/heatmapIcon.png" alt="Heatmap" class="sidebar-icon">
                    <span>Heatmap</span>
                </a>

                <a href="#" onclick="showBoxPlot()">
                    <img src="assets/boxPlotIcon.png" alt="Box Plot" class="sidebar-icon">
                    <span>Box Plot</span>
                </a>
                
                <a href="#" onclick="show3DScatter()">
                    <img src="assets/threeDScatterPlotIcon.png" alt="3D Scatter" class="sidebar-icon">
                    <span>3D Scatter</span>
                </a>
            </div>
    </div>

    <div id="main">
        <div id="workspaces">
            <div class="workspace active" id="workspace1">
                <span class="workspace-name">Workspace 1</span>
                <button class="close-workspace">&times;</button>
            </div>
            <button id="addWorkspace">+</button>
        </div>
        <div id="workspaceContents">
            <div class="workspace-content active" id="workspaceContent1">
                <!-- Content for Workspace 1 -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div id="propertySelectContainer1" style="display: none;">
                            <label for="propertySelect1" class="form-label">Select map property:</label>
                            <select id="propertySelect1" class="form-select propertySelect"></select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div id="map1" class="map"></div>
                    </div>
                    <div class="col-md-6">
                        <div id="histogram1" class="histogram"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div id="tableContainer1" class="tableContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script>
// ------------------------------------------------------------------------------------------------------------
        
        function getColor(value, min, max) {
            const ratio = (value - min) / (max - min);
            const hue = (1 - ratio) * 60; // 60 for yellow, 0 for red
            return `hsl(${hue}, 100%, 50%)`;
        }

        let workspaceCount = 1;
        let currentWorkspace = 1;
        let workspaceData = {
            1: { geojson: null, map: null, histogram: null }
        };
// ------------------------------------------------------------------------------------------------------------
        
        function addWorkspace() {
            workspaceCount++;
            const newWorkspace = document.createElement('div');
            newWorkspace.className = 'workspace';
            newWorkspace.id = `workspace${workspaceCount}`;
            newWorkspace.innerHTML = `
                <span class="workspace-name">Workspace ${workspaceCount}</span>
                <button class="close-workspace">&times;</button>
            `;
            document.getElementById('addWorkspace').before(newWorkspace);

            const newContent = document.createElement('div');
            newContent.className = 'workspace-content';
            newContent.id = `workspaceContent${workspaceCount}`;
            newContent.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="propertySelect${workspaceCount}" class="form-label">Select property:</label>
                        <select id="propertySelect${workspaceCount}" class="form-select propertySelect"></select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div id="map${workspaceCount}" class="map"></div>
                    </div>
                    <div class="col-md-6">
                        <div id="histogram${workspaceCount}" class="histogram"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div id="tableContainer${workspaceCount}" class="tableContainer"></div>
                    </div>
                </div>
            `;
            document.getElementById('workspaceContents').appendChild(newContent);

            workspaceData[workspaceCount] = { geojson: null, map: null, histogram: null };

            attachWorkspaceListeners(newWorkspace);
            switchToWorkspace(workspaceCount).then(() => {
                // Any additional actions after switching workspace
            });
        }
// ------------------------------------------------------------------------------------------------------------
        
        function switchToWorkspace(workspaceId) {
            return new Promise((resolve) => {
                document.querySelectorAll('.workspace').forEach(w => w.classList.remove('active'));
                document.querySelectorAll('.workspace-content').forEach(w => w.classList.remove('active'));
                
                document.getElementById(`workspace${workspaceId}`).classList.add('active');
                document.getElementById(`workspaceContent${workspaceId}`).classList.add('active');
                
                currentWorkspace = workspaceId;

                // Initialize map if it doesn't exist
                if (!workspaceData[workspaceId].map) {
                    const mapContainer = document.getElementById(`map${workspaceId}`);
                    if (mapContainer) {
                        workspaceData[workspaceId].map = L.map(`map${workspaceId}`).setView([0, 0], 2);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors'
                        }).addTo(workspaceData[workspaceId].map);
                    } else {
                        console.error(`Map container not found for workspace ${workspaceId}`);
                    }
                }

                // Use setTimeout to ensure the map is fully initialized
                setTimeout(() => {
                    resolve();
                }, 100);
            });
        }
// ------------------------------------------------------------------------------------------------------------
        
        function attachWorkspaceListeners(workspace) {
            workspace.addEventListener('click', function() {
                switchToWorkspace(this.id.replace('workspace', ''));
            });

            workspace.querySelector('.close-workspace').addEventListener('click', function(e) {
                e.stopPropagation();
                if (document.querySelectorAll('.workspace').length > 1) {
                    const workspaceId = workspace.id.replace('workspace', '');
                    document.getElementById(`workspaceContent${workspaceId}`).remove();
                    workspace.remove();
                    delete workspaceData[workspaceId];
                    switchToWorkspace(Object.keys(workspaceData)[0]);
                }
            });

            workspace.addEventListener('dblclick', function() {
                const nameSpan = this.querySelector('.workspace-name');
                const newName = prompt('Enter new workspace name:', nameSpan.textContent);
                if (newName) {
                    nameSpan.textContent = newName;
                }
            });
        }

        document.getElementById('addWorkspace').addEventListener('click', addWorkspace);
        attachWorkspaceListeners(document.getElementById('workspace1'));

        let legend;
        let currentGeoJSON;

        function toggleSecondaryNav() {
            var secondarySidebar = document.getElementById("secondarySidebar");
            var importSection = document.getElementById("importSection");
            var main = document.getElementById("main");
            if (secondarySidebar.style.width === "12em") {
                secondarySidebar.style.width = "0";
                main.style.marginLeft = "3em"; // Just the width of the main sidebar
                importSection.style.display = "none";
            } else {
                secondarySidebar.style.width = "12em";
                main.style.marginLeft = "15em"; // 3em (main sidebar) + 12em (secondary sidebar)
            }
        }
// ------------------------------------------------------------------------------------------------------------
        
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
// ------------------------------------------------------------------------------------------------------------
        
        // Modify existing functions to work with multiple workspaces
        function processShapefile() {
            const shpFile = document.getElementById('shpFile').files[0];
            const dbfFile = document.getElementById('dbfFile').files[0];

            if (!shpFile || !dbfFile) {
                alert('Please select both .shp and .dbf files');
                return;
            }

            Promise.all([readFile(shpFile), readFile(dbfFile)])
                .then(([shpBuffer, dbfBuffer]) => {
                    shapefile.read(shpBuffer, dbfBuffer)
                        .then(geojson => {
                            console.log('GeoJSON created successfully:', geojson);
                            workspaceData[currentWorkspace].geojson = geojson;
                            
                            // Wait for the workspace to be ready before rendering
                            switchToWorkspace(currentWorkspace).then(() => {
                                populatePropertySelect(geojson.features[0].properties);
                                renderColorfulMap(geojson);
                                populateFileVariablesList(shpFile.name, geojson.features[0].properties);
                            });
                        })
                        .catch(error => {
                            console.error('Error processing shapefile:', error);
                            alert('Error processing shapefile. Please check the console for details.');
                        });
                }).catch(error => {
                    console.error('Error reading files:', error);
                    alert('Error reading files. Please check the console for details.');
                });
        }
// ------------------------------------------------------------------------------------------------------------
        
        function populateFileVariablesList(fileName, properties) {
            const fileNameElement = document.getElementById('fileName');
            const variableList = document.getElementById('variableList');
            const fileVariablesSection = document.getElementById('fileVariablesSection');
            const fileNameToggle = document.getElementById('fileNameToggle');

            fileNameElement.textContent = fileName;
            variableList.innerHTML = '';

            for (let prop in properties) {
                let li = document.createElement('li');
                li.textContent = prop;
                variableList.appendChild(li);
            }

            fileVariablesSection.style.display = 'block';

            // Add click event to toggle the list
            fileNameToggle.addEventListener('click', function() {
                variableList.style.display = variableList.style.display === 'none' ? 'block' : 'none';
                fileNameToggle.querySelector('i').classList.toggle('fa-chevron-down');
                fileNameToggle.querySelector('i').classList.toggle('fa-chevron-up');
            });
        }
// ------------------------------------------------------------------------------------------------------------
        
        function populatePropertySelect(properties) {
            const select = document.getElementById(`propertySelect${currentWorkspace}`);
            if (!select) {
                console.error(`Property select element not found for workspace ${currentWorkspace}`);
                return;
            }
            select.innerHTML = '';
            for (let prop in properties) {
                if (typeof properties[prop] === 'number') {
                    let option = document.createElement('option');
                    option.value = prop;
                    option.textContent = prop;
                    select.appendChild(option);
                }
            }
            select.addEventListener('change', function() {
                if (workspaceData[currentWorkspace].geojson) {
                    renderColorfulMap(workspaceData[currentWorkspace].geojson);
                }
            });
            // Trigger change event to render the map with the first property
            select.dispatchEvent(new Event('change'));
        }
// ------------------------------------------------------------------------------------------------------------
        // Function to render the colorful map
        function renderColorfulMap(geojson) {
            const propertyName = document.getElementById(`propertySelect${currentWorkspace}`).value;
            const map = workspaceData[currentWorkspace].map;

            // Check if we need to create point features from coordinate columns
            if (geojson.features[0].geometry && geojson.features[0].geometry.type === 'Point') {
                // No need for conversion, points are already correctly formatted
            } else if (geojson.features[0].geometry === null) {
                let latField = 'Lat', lonField = 'Long';
                if (geojson.features[0].properties.hasOwnProperty('Y') && 
                    geojson.features[0].properties.hasOwnProperty('X')) {
                    latField = 'Y';
                    lonField = 'X';
                }

                if (geojson.features[0].properties.hasOwnProperty(latField) && 
                    geojson.features[0].properties.hasOwnProperty(lonField)) {

                    geojson.features.forEach(feature => {
                        const lat = parseFloat(feature.properties[latField]);
                        const lon = parseFloat(feature.properties[lonField]);

                        // Debugging: Log the coordinates
                        console.log(`Lat: ${lat}, Lon: ${lon}`);

                        // Validate coordinates
                        if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                            console.error(`Invalid coordinates for feature: ${feature.properties}`);
                            return;
                        }

                        feature.geometry = {
                            type: "Point",
                            coordinates: [lon, lat]
                        };
                    });
                } else {
                    console.error('Cannot find latitude and longitude fields');
                    alert('Error: Cannot find latitude and longitude fields in the data');
                    return;
                }
            }

            const values = geojson.features.map(f => f.properties[propertyName]);
            const min = Math.min(...values);
            const max = Math.max(...values);

            if (workspaceData[currentWorkspace].geoJsonLayer) {
                map.removeLayer(workspaceData[currentWorkspace].geoJsonLayer);
            }

            workspaceData[currentWorkspace].geoJsonLayer = L.geoJSON(geojson, {
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 8,
                        fillColor: getColor(feature.properties[propertyName], min, max),
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                },
                style: function(feature) {
                    return {
                        fillColor: getColor(feature.properties[propertyName], min, max),
                        weight: 2,
                        opacity: 1,
                        color: 'white',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties) {
                        layer.bindPopup(Object.keys(feature.properties).map(key => 
                            `<strong>${key}:</strong> ${feature.properties[key]}`
                        ).join('<br>'));
                    }
                }
            }).addTo(map);

            map.fitBounds(workspaceData[currentWorkspace].geoJsonLayer.getBounds());

            // Add or update legend
            if (workspaceData[currentWorkspace].legend) {
                map.removeControl(workspaceData[currentWorkspace].legend);
            }
            workspaceData[currentWorkspace].legend = L.control({position: 'bottomright'});
            workspaceData[currentWorkspace].legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const grades = [min, min + (max-min)/4, min + (max-min)/2, min + 3*(max-min)/4, max];
                div.innerHTML += `<h4>${propertyName}</h4>`;
                for (let i = 0; i < grades.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + getColor(grades[i], min, max) + '"></i> ' +
                        grades[i].toFixed(2) + (grades[i + 1] ? '&ndash;' + grades[i + 1].toFixed(2) + '<br>' : '+');
                }
                return div;
            };
            workspaceData[currentWorkspace].legend.addTo(map);
        }
        
        document.addEventListener('change', function(event) {
            if (event.target && event.target.id.startsWith('propertySelect')) {
                const workspaceId = event.target.id.replace('propertySelect', '');
                if (workspaceData[workspaceId] && workspaceData[workspaceId].geojson) {
                    renderColorfulMap(workspaceData[workspaceId].geojson);
                }
            }
        });
// ------------------------------------------------------------------------------------------------------------
        
        // Function to render the table
        function renderTable() {
            if (!workspaceData[currentWorkspace].geojson) {
                alert('Please upload and process a shapefile first.');
                return;
            }

            const tableContainer = document.getElementById(`tableContainer${currentWorkspace}`);
            const geojson = workspaceData[currentWorkspace].geojson;
            table.className = 'table table-striped table-hover';

            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const properties = geojson.features[0].properties;
            for (let prop in properties) {
                const th = document.createElement('th');
                th.textContent = prop;
                headerRow.appendChild(th);
            }
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create table body
            const tbody = document.createElement('tbody');
            geojson.features.forEach(feature => {
                const row = document.createElement('tr');
                for (let prop in feature.properties) {
                    const td = document.createElement('td');
                    td.textContent = feature.properties[prop];
                    row.appendChild(td);
                }
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);
        }
// ------------------------------------------------------------------------------------------------------------
        
        function showMap() {
            console.log("Showing Map");
            document.getElementById(`map${currentWorkspace}`).style.display = 'block';
            document.getElementById(`histogram${currentWorkspace}`).style.display = 'none';
            document.getElementById(`tableContainer${currentWorkspace}`).style.display = 'none';
            document.getElementById(`propertySelectContainer${currentWorkspace}`).style.display = 'block';
        }
// ------------------------------------------------------------------------------------------------------------
        
        function showTable() {
            console.log("Showing Table");
            renderTable();
            document.getElementById(`map${currentWorkspace}`).style.display = 'none';
            document.getElementById(`histogram${currentWorkspace}`).style.display = 'none';
            document.getElementById(`tableContainer${currentWorkspace}`).style.display = 'block';
            document.getElementById(`propertySelectContainer${currentWorkspace}`).style.display = 'none';
        }
// ------------------------------------------------------------------------------------------------------------
        
        // Add this new function to handle property selection for histogram
        function selectHistogramProperty() {
            histogramProperty = document.getElementById('propertySelect').value;
            renderHistogram();
        }

        let histogramProperty = '';
// ------------------------------------------------------------------------------------------------------------
        
        function showHistogram() {
            console.log("Showing Histogram");
            document.getElementById(`map${currentWorkspace}`).style.display = 'none';
            document.getElementById(`histogram${currentWorkspace}`).style.display = 'block';
            document.getElementById(`tableContainer${currentWorkspace}`).style.display = 'none';
            document.getElementById(`propertySelectContainer${currentWorkspace}`).style.display = 'none';
            renderHistogram();
        }
// ------------------------------------------------------------------------------------------------------------
        
        function renderHistogram() {
            if (!workspaceData[currentWorkspace].geojson) {
                alert('Please upload and process a shapefile first.');
                return;
            }

            const geojson = workspaceData[currentWorkspace].geojson;
            const xProperty = geojson.features[0].properties.hasOwnProperty('ID') ? 'ID' : 
                            geojson.features[0].properties.hasOwnProperty('Object Id') ? 'Object Id' : 
                            Object.keys(geojson.features[0].properties)[0];

            const yProperty = document.getElementById(`propertySelect${currentWorkspace}`).value;

            const xValues = geojson.features.map(f => f.properties[xProperty]);
            const yValues = geojson.features.map(f => f.properties[yProperty]);

            const trace = {
                x: xValues,
                y: yValues,
                type: 'bar'
            };

            const layout = {
                title: `Histogram of ${yProperty}`,
                xaxis: { title: xProperty },
                yaxis: { title: yProperty }
            };

            Plotly.newPlot(`histogram${currentWorkspace}`, [trace], layout);
        }
// ------------------------------------------------------------------------------------------------------------
        
        function showScatterPlot() {
            console.log("Showing Scatter Plot");
            // Implement scatter plot visualization
        }

        function showCumulativeDistribution() {
            console.log("Showing Cumulative Distribution Plot");
            // Implement cumulative distribution plot
        }

        function showHeatmap() {
            console.log("Showing Heatmap");
            // Implement heatmap visualization
        }

        function showBoxPlot() {
            console.log("Showing Box Plot");
            // Implement box plot visualization
        }

        function show3DScatter() {
            console.log("Showing 3D Scatter");
            // Implement 3D scatter plot visualization
        }
// ------------------------------------------------------------------------------------------------------------
        
        function showImportOptions() {
            var secondarySidebar = document.getElementById("secondarySidebar");
            var importSection = document.getElementById("importSection");
            var fileVariablesSection = document.getElementById("fileVariablesSection");
            var visualizationButtons = document.getElementById("visualizationButtons");
            var main = document.getElementById("main");

            // Show the secondary sidebar if it's not already visible
            if (secondarySidebar.style.width !== "12em") {
                secondarySidebar.style.width = "12em";
                main.style.marginLeft = "15em"; // Adjusted margin to account for both sidebars
            }

            // Show the import section and hide other sections
            importSection.style.display = "block";
            fileVariablesSection.style.display = "none";
            visualizationButtons.style.display = "none";
        }
// ------------------------------------------------------------------------------------------------------------
        
        function showVisualizationOptions() {
            var secondarySidebar = document.getElementById("secondarySidebar");
            var importSection = document.getElementById("importSection");
            var fileVariablesSection = document.getElementById("fileVariablesSection");
            var visualizationButtons = document.getElementById("visualizationButtons");
            var main = document.getElementById("main");

            // Show the secondary sidebar if it's not already visible
            if (secondarySidebar.style.width !== "12em") {
                secondarySidebar.style.width = "12em";
                main.style.marginLeft = "15em";
            }

            // Show the visualization buttons and hide other sections
            importSection.style.display = "none";
            fileVariablesSection.style.display = "none";
            visualizationButtons.style.display = "block";
        }

    </script>
</body>
</html>