<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W2MTTJPMHD"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-W2MTTJPMHD');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shapefile Viewer with Bootstrap</title>
    <!-- External CSS libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- External JS libraries -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script>
    <style>
        /* Styles for the map container */
        #map { height: 500px; width: 100%; }
        /* Styles for the legend */
        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .info h4 { margin: 0 0 5px; color: #777; }
        .legend {
            line-height: 18px;
            color: #555;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

    /* Styles for the main sidebar */
    .main-sidebar {
        height: 100%;
        width: 3%;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        background-color: #111;
        overflow-x: hidden;
        transition: 0.5s;
        padding-top: 20px;
        white-space: nowrap;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .main-sidebar a {
        padding: 15px 0;
        margin-bottom: 10px; /* Added margin between buttons */
        text-decoration: none;
        font-size: 18px;
        color: #e6e5e5;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        transition: 0.3s;
    }

    .main-sidebar:hover {
        width: 250px;
    }

    .main-sidebar:hover a {
        flex-direction: row;
        justify-content: flex-start;
        padding-left: 32px;
    }

    .main-sidebar .fa-bars {
        font-size: 24px;
    }

    .menu-text {
        display: none;
        margin-left: 10px;
    }

    .main-sidebar:hover .menu-text {
        display: inline;
    }

    /* Styles for the secondary sidebar */
    .secondary-sidebar {
        height: 100%;
        width: 0;
        position: fixed;
        z-index: 999;
        top: 0;
        left: 60px;
        background-color: #f8f9fa;
        overflow-x: hidden;
        transition: 0.5s;
        padding-top: 25px;
    }

    .secondary-sidebar a {
        padding: 12px 8px 12px 32px; /* Increased top and bottom padding */
        margin-bottom: 10px; /* Added margin between buttons */
        text-decoration: none;
        font-size: 18px;
        color: #818181;
        display: flex;
        align-items: center;
        transition: 0.3s;
    }

    .secondary-sidebar a:hover {
        color: #111;
    }

    /* Style for sidebar icons */
    .sidebar-icon {
        width: 24px;
        height: 24px;
        margin-right: 10px;
    }


    /* Style for all icons in the main sidebar to make them white */
    .main-sidebar .sidebar-icon {
        filter: brightness(0) invert(1);
    }
    </style>
</head>
<body>
    <!-- Main sidebar -->
    <div id="mainSidebar" class="main-sidebar">
        <!-- Hamburger menu icon -->
        <a href="javascript:void(0)" onclick="toggleSecondaryNav()">
            <i class="fas fa-bars"></i>
        </a>
        
        <!-- Data button with icon -->
        <a href="javascript:void(0)" onclick="showDataOptions()">
            <img src="assets/dataIcon.png" alt="Data" class="sidebar-icon">
            <span class="menu-text">Data</span>
        </a>
        
        <!-- Visualizations button with icon -->
        <a href="javascript:void(0)" onclick="toggleSecondaryNav()">
            <img src="assets/scatterPlotIcon.png" alt="Visualizations" class="sidebar-icon visualizations-icon">
            <span class="menu-text">Visualizations</span>
        </a>

         <!-- Home button with icon -->
        <a href="vestaHome.html">
            <img src="assets/homeIcon.png" alt="Home" class="sidebar-icon">
            <span class="menu-text">Home</span>
        </a>
    </div>

    <!-- Secondary sidebar -->
    <div id="secondarySidebar" class="secondary-sidebar">
        <!-- Map button with icon -->
        <a href="#" onclick="showMap()">
            <img src="assets/mapIcon.png" alt="Map" class="sidebar-icon">
            <span>Map</span>
        </a>
        <!-- Table button with icon -->
        <a href="#" onclick="showTable()">
            <img src="assets/tableIcon.png" alt="Table" class="sidebar-icon">
            <span>Table</span>
        </a>
        <!-- Histogram button with icon -->
        <a href="#" onclick="showHistogram()">
            <img src="assets/histogramIcon.png" alt="Histogram" class="sidebar-icon">
            <span>Histogram</span>
        </a>
        <!-- Scatter Plot button with icon -->
        <a href="#" onclick="showScatterPlot()">
            <img src="assets/scatterPlotIcon.png" alt="Scatter Plot" class="sidebar-icon">
            <span>Scatter Plot</span>
        </a>

        <a href="#" onclick="showCumulativeDistribution()">
            <img src="assets/cdPlotIcon.png" alt="Cumulative Distribution Plot" class="sidebar-icon">
            <span>Cumulative Distribution Plot</span>
        </a>

        <a href="#" onclick="showHeatmap()">
            <img src="assets/heatmapIcon.png" alt="Heatmap" class="sidebar-icon">
            <span>Heatmap</span>
        </a>

        <a href="#" onclick="showBoxPlot()">
            <img src="assets/boxPlotIcon.png" alt="Box Plot" class="sidebar-icon">
            <span>Box Plot</span>
        </a>
        
        <a href="#" onclick="show3DScatter()">
            <img src="assets/threeDScatterPlotIcon.png" alt="3D Scatter" class="sidebar-icon">
            <span>3D Scatter</span>
        </a>
    </div>

    <div id="main">
        <div class="container mt-5">
            <h1 class="mb-4">Shapefile Viewer</h1>
            <div class="row mb-3">
                <!-- File input for .shp file -->
                <div class="col-md-4">
                    <label for="shpFile" class="form-label">Select .shp file:</label>
                    <input type="file" class="form-control" id="shpFile" accept=".shp">
                </div>
                <!-- File input for .dbf file -->
                <div class="col-md-4">
                    <label for="dbfFile" class="form-label">Select .dbf file:</label>
                    <input type="file" class="form-control" id="dbfFile" accept=".dbf">
                </div>
                <!-- Dropdown for selecting property to display -->
                <div class="col-md-4">
                    <label for="propertySelect" class="form-label">Select property:</label>
                    <select id="propertySelect" class="form-select"></select>
                </div>
            </div>
            <!-- Button to trigger file processing and map rendering -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <button onclick="processShapefile()" class="btn btn-primary">Upload and Render</button>
                </div>
            </div>

            <!-- Container for the map -->
            <div class="row">
                <div class="col-md-12">
                    <div id="map"></div>
                </div>
            </div>

            <!-- Button to render table -->
            <div class="row mb-3">
                <div class="col-md-12">
                    <button onclick="renderTable()" class="btn btn-secondary">Show Data Table</button>
                </div>
            </div>

            <!-- Container for the table -->
            <div class="row">
                <div class="col-md-12">
                    <div id="tableContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    <script>
        // Initialize the map
        let map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let legend;
        let currentGeoJSON;

        function toggleSecondaryNav() {
            var secondarySidebar = document.getElementById("secondarySidebar");
            var main = document.getElementById("main");
            if (secondarySidebar.style.width === "250px") {
                secondarySidebar.style.width = "0";
                main.style.marginLeft = "60px";
            } else {
                secondarySidebar.style.width = "250px";
                main.style.marginLeft = "310px";
            }
        }

        function showDataOptions() {
            console.log("Showing Data Options");
            // Implement data options functionality
        }

        // Function to process the uploaded shapefile
        function processShapefile() {
            const shpFile = document.getElementById('shpFile').files[0];
            const dbfFile = document.getElementById('dbfFile').files[0];

            if (!shpFile || !dbfFile) {
                alert('Please select both .shp and .dbf files');
                return;
            }

            // Read both files and process them
            Promise.all([
                readFile(shpFile),
                readFile(dbfFile)
            ]).then(([shpBuffer, dbfBuffer]) => {
                shapefile.read(shpBuffer, dbfBuffer)
                    .then(geojson => {
                        console.log('GeoJSON created successfully:', geojson);
                        currentGeoJSON = geojson;
                        populatePropertySelect(geojson.features[0].properties);
                        renderColorfulMap(geojson);
                    })
                    .catch(error => {
                        console.error('Error processing shapefile:', error);
                        alert('Error processing shapefile. Please check the console for details.');
                    });
            }).catch(error => {
                console.error('Error reading files:', error);
                alert('Error reading files. Please check the console for details.');
            });
        }

        // Function to read a file as ArrayBuffer
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // Function to populate the property select dropdown
        function populatePropertySelect(properties) {
            const select = document.getElementById('propertySelect');
            select.innerHTML = '';
            for (let prop in properties) {
                if (typeof properties[prop] === 'number') {
                    let option = document.createElement('option');
                    option.value = prop;
                    option.textContent = prop;
                    select.appendChild(option);
                }
            }
            // Trigger change event to render the map with the first property
            select.dispatchEvent(new Event('change'));
        }

        // Function to get color based on value
        function getColor(value, min, max) {
            const ratio = (value - min) / (max - min);
            const hue = (1 - ratio) * 60; // 60 for yellow, 0 for red
            return `hsl(${hue}, 100%, 50%)`;
        }

        // Function to render the colorful map
        function renderColorfulMap(geojson) {
            const propertyName = document.getElementById('propertySelect').value;

            // Check if we need to create point features from coordinate columns
            if (geojson.features[0].geometry && geojson.features[0].geometry.type === 'Point') {
                // No need for conversion, points are already correctly formatted
            } else if (geojson.features[0].geometry === null) {
                let latField = 'Lat', lonField = 'Long';
                if (geojson.features[0].properties.hasOwnProperty('Y') && 
                    geojson.features[0].properties.hasOwnProperty('X')) {
                    latField = 'Y';
                    lonField = 'X';
                }

                if (geojson.features[0].properties.hasOwnProperty(latField) && 
                    geojson.features[0].properties.hasOwnProperty(lonField)) {

                    geojson.features.forEach(feature => {
                        const lat = parseFloat(feature.properties[latField]);
                        const lon = parseFloat(feature.properties[lonField]);

                        // Debugging: Log the coordinates
                        console.log(`Lat: ${lat}, Lon: ${lon}`);

                        // Validate coordinates
                        if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                            console.error(`Invalid coordinates for feature: ${feature.properties}`);
                            return;
                        }

                        feature.geometry = {
                            type: "Point",
                            coordinates: [lon, lat]
                        };
                    });
                } else {
                    console.error('Cannot find latitude and longitude fields');
                    alert('Error: Cannot find latitude and longitude fields in the data');
                    return;
                }
            }

            const values = geojson.features.map(f => f.properties[propertyName]);
            const min = Math.min(...values);
            const max = Math.max(...values);

            if (window.geoJsonLayer) {
                map.removeLayer(window.geoJsonLayer);
            }

            window.geoJsonLayer = L.geoJSON(geojson, {
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        radius: 8,
                        fillColor: getColor(feature.properties[propertyName], min, max),
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                },
                style: function(feature) {
                    return {
                        fillColor: getColor(feature.properties[propertyName], min, max),
                        weight: 2,
                        opacity: 1,
                        color: 'white',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties) {
                        layer.bindPopup(Object.keys(feature.properties).map(key => 
                            `<strong>${key}:</strong> ${feature.properties[key]}`
                        ).join('<br>'));
                    }
                }
            }).addTo(map);

            map.fitBounds(window.geoJsonLayer.getBounds());

            // Add or update legend
            if (legend) {
                map.removeControl(legend);
            }
            legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const grades = [min, min + (max-min)/4, min + (max-min)/2, min + 3*(max-min)/4, max];
                div.innerHTML += `<h4>${propertyName}</h4>`;
                for (let i = 0; i < grades.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + getColor(grades[i], min, max) + '"></i> ' +
                        grades[i].toFixed(2) + (grades[i + 1] ? '&ndash;' + grades[i + 1].toFixed(2) + '<br>' : '+');
                }
                return div;
            };
            legend.addTo(map);
        }

        // Event listener for property select change
        document.getElementById('propertySelect').addEventListener('change', function() {
            if (currentGeoJSON) {
                renderColorfulMap(currentGeoJSON);
            }
        });

        // Function to render the table
        function renderTable() {
            if (!currentGeoJSON) {
                alert('Please upload and process a shapefile first.');
                return;
            }

            const tableContainer = document.getElementById('tableContainer');
            const table = document.createElement('table');
            table.className = 'table table-striped table-hover';

            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const properties = currentGeoJSON.features[0].properties;
            for (let prop in properties) {
                const th = document.createElement('th');
                th.textContent = prop;
                headerRow.appendChild(th);
            }
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create table body
            const tbody = document.createElement('tbody');
            currentGeoJSON.features.forEach(feature => {
                const row = document.createElement('tr');
                for (let prop in feature.properties) {
                    const td = document.createElement('td');
                    td.textContent = feature.properties[prop];
                    row.appendChild(td);
                }
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);
        }

        function showMap() {
            console.log("Showing Map");
            // Hide other visualizations and show the map
            document.getElementById('map').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'none';
            // Add similar lines for other visualization containers when implemented
        }

        function showTable() {
            console.log("Showing Table");
            renderTable();
            document.getElementById('map').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';
            // Add similar lines for other visualization containers when implemented
        }

        function showHistogram() {
            console.log("Showing Histogram");
            // Implement histogram visualization
        }

        function showScatterPlot() {
            console.log("Showing Scatter Plot");
            // Implement scatter plot visualization
        }

        function showCumulativeDistribution() {
            console.log("Showing Cumulative Distribution Plot");
            // Implement cumulative distribution plot
        }

        function showHeatmap() {
            console.log("Showing Heatmap");
            // Implement heatmap visualization
        }

        function showBoxPlot() {
            console.log("Showing Box Plot");
            // Implement box plot visualization
        }

        function show3DScatter() {
            console.log("Showing 3D Scatter");
            // Implement 3D scatter plot visualization
        }
    </script>
</body>
</html>